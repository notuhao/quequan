<!--
  2025 ä½œè€…ï¼šæœ«ä¼ä¹‹å¤œã€‚
  åŸºäº MIT License å¼€æºã€‚
  è¯·åŠ¡å¿…ä»å¯é æ¥æºè®¿é—®æœ€æ–°ç‰ˆæœ¬ï¼š
  æ®‹å…½å‰è¿›åŸºåœ°ï¼ˆä¸‹ç­é­”åŒäººä¾§ï¼‰ ç¾¤å·ç ï¼š805836168
  é­”æ³•å›½åº¦å¨±ä¹ä¸­å¿ƒï¼ˆä¸‹ç­é­”æ¸¸æˆç¾¤ï¼‰ ç¾¤å·ç ï¼š109252951
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›€æƒï¼šç¬¬äºŒå±Šç¿ é›€æ¯å¼€èµ›</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- å†…è”æ ·å¼ -->
  <style>
    body { background: #f0f2f5; }
    .stat { width: 100px; }
    .progress-wrapper { position: relative; display: inline-block; }
    .arrow { position: absolute; top: -18px; right: -2px; font-size: 14px; visibility: hidden; }
    #game-card.swipeable:active { cursor: grabbing; }
    #game-card.swipeable.swipe-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
    #game-card.swipeable.swipe-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
    #stats .progress { background: #e9ecef; }
    #turn-count { text-align: center; margin-bottom: 1rem; }
    /* æ¸¸æˆç»“æŸè¦†ç›– */
    #game-over {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); color: #fff;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 1.2rem; z-index: 1000;
    }
    #game-over button { margin-top: 1rem; }
    /* äº‹ä»¶æ–‡æœ¬ä¿ç•™æ¢è¡Œï¼Œå·¦å¯¹é½ */
    #event-text { white-space: pre-wrap; text-align: left; }
    /* é¡µè„šæ ·å¼ */
    footer { text-align: center; padding: 8px 0; color: #888; font-size: 0.85rem; }
  </style>
</head>
<body>
  <!-- æˆæƒå¼¹çª— -->
  <div class="modal fade" id="authModal" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">è¯·è¾“å…¥è®¿é—®å¯†ç </h5></div>
        <div class="modal-header">æ¸¸æˆå°šæœªå¼€å‘å®Œæˆï¼Œä»…ä¾›æ¸¸æˆç¾¤å†…éƒ¨è·å¾—æˆæƒçš„å¼€å‘æµ‹è¯•äººå‘˜ä½¿ç”¨ã€‚</div>
        <div class="modal-body">
          <input type="password" id="authInput" class="form-control" placeholder="Password">
          <div id="authError" class="text-danger small mt-2" style="display:none;">å¯†ç é”™è¯¯ï¼Œè¯·åŠ ç¾¤è·å–å¯†ç </div>
        </div>
        <div class="modal-footer">
          <button id="authBtn" class="btn btn-primary btn-block">è¿›å…¥æ¸¸æˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-3">
    <!-- å›åˆæ•°ï¼šé¡µé¢æœ€ä¸Šæ–¹å±…ä¸­ -->
    <div id="turn-count" class="text-center">
      <small>å›åˆ</small>
      <div><span id="turn-number">0</span></div>
    </div>
    <!-- é¡¶éƒ¨ä¿¡æ¯ï¼šçŠ¶æ€æ  -->
    <div id="stats" class="d-flex justify-content-around align-items-center mb-4">
      <!-- å°ç’ -->
      <div class="stat text-center position-relative">
        <small>å°ç’</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr1" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr1" class="arrow"></span>
        </div>
      </div>
      <!-- å¤å‡‰ -->
      <div class="stat text-center position-relative">
        <small>å¤å‡‰</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr2" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr2" class="arrow"></span>
        </div>
      </div>
      <!-- å°ç™½ -->
      <div class="stat text-center position-relative">
        <small>å°ç™½</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr3" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr3" class="arrow"></span>
        </div>
      </div>
      <!-- è´£ä»» -->
      <div class="stat text-center position-relative">
        <small>è´£ä»»</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr4" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr4" class="arrow"></span>
        </div>
      </div>
    </div>
    <!-- å¡ç‰ŒåŒºåŸŸ -->
    <div class="d-flex justify-content-center align-items-center" style="height: 70vh;">
      <div id="game-card" class="card shadow-lg rounded-3 swipeable" style="width: 350px; cursor: grab; transition: transform 0.3s;">
        <div class="card-body d-flex align-items-center justify-content-start" style="height: 200px;">
          <p id="event-text" class="card-text">åŠ è½½ä¸­...</p>
        </div>
        <div class="card-footer d-flex justify-content-between">
          <button id="btn-left" class="btn btn-danger"><i class="fas fa-thumbs-down fa-lg"></i></button>
          <button id="btn-right" class="btn btn-success"><i class="fas fa-thumbs-up fa-lg"></i></button>
        </div>
      </div>
    </div>
  </div>
  <!-- é¡µè„šç‰ˆæƒå£°æ˜ -->
  <footer>
    æç¤ºï¼šå·¦å³æ‹–åŠ¨å¡ç‰‡æˆ–å°†å…‰æ ‡æ”¾ç½®åœ¨é€‰é¡¹ä¸Šï¼Œå¯ä»¥é¢„è§ˆæ•°å€¼å˜åŒ–ã€‚<br>
    2025 æœ«ä¼ä¹‹å¤œ<br>
    è¯·ä»å¯é æ¥æºè®¿é—®æœ€æ–°ç‰ˆæœ¬ã€‚<br><a href="https://github.com/notuhao/quequan-game" target="_blank">GitHub</a><br><a href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=7SkPyirELH-LN52Tz8PHjl1TLqbHwhdh&authKey=fGUcO5nmulznuZrZUGGJ01CFS4phfoPdo%2B3QoppW5FwcsO%2BsuLHRcpTSdhqYVPrF&noverify=0&group_code=805836168" target="_blank">æ®‹å…½å‰è¿›åŸºåœ°ï¼ˆä¸‹ç­é­”åŒäººä¾§ï¼‰</a><br><a href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=rU7wcxZXUtC-U1nafP29Cgv5CfFWlAHl&authKey=%2BrMuEaGIlWVNL7ZKvs1ZoZBWUsUk9X7MEmDMeG1Xy5t86nekeIENl%2BLFytjC4zzg&noverify=0&group_code=109252951" target="_blank">é­”æ³•å›½åº¦å¨±ä¹ä¸­å¿ƒï¼ˆä¸‹ç­é­”æ¸¸æˆç¾¤ï¼‰</a>
  </footer>
  <!-- åº“æ–‡ä»¶ -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <!-- Bootstrap 5 çš„ JS Bundleï¼ŒåŒ…å« Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- å†…è”è„šæœ¬ -->
  <script>
  // æŠŠè¿™è¡Œæ”¾åœ¨æœ€å¤–å±‚ $(function(){â€¦}) ä¹‹å¤–ï¼Œæˆ–è€…æ”¾æœ€é¡¶éƒ¨
  const AUTH_KEY = 'quequanAuthorized';

  $(function() {
    ////////////////////////////////////////
    // â€”â€” é…ç½®é¡¹ï¼šæ˜¯å¦éœ€è¦å¯†ç  â€”â€” //
    const REQUIRE_PASSWORD = true;       // æ”¹ä¸º false åˆ™è·³è¿‡å¯†ç 
    const ALLOWED_PASSWORD = '109252951';
    ////////////////////////////////////////
    function startApp() {
     fetchEventsAndStart();
    }

    if (REQUIRE_PASSWORD) {
     // å¦‚æœ sessionStorage æœ‰æ ‡è®°ï¼Œåˆ™ç›´æ¥å¯åŠ¨
     if (sessionStorage.getItem(AUTH_KEY) === 'true') {
       startApp();
     } else {
       // é¦–æ¬¡æœªæˆæƒï¼Œå¼¹çª—æ ¡éªŒ
       const authModal = new bootstrap.Modal(document.getElementById('authModal'), {
         backdrop: 'static', keyboard: false
       });
       authModal.show();

       $('#authBtn').on('click', () => {
         const val = $('#authInput').val();
         if (val === ALLOWED_PASSWORD) {
           // æˆæƒæˆåŠŸï¼Œè®°å½•æ ‡è®°
           sessionStorage.setItem(AUTH_KEY, 'true');
           authModal.hide();
           startApp();
         } else {
           $('#authError').show();
         }
       });
     }
    } else {
     startApp();
    }
  });

  // ä»å¤–éƒ¨ JSON åŠ è½½äº‹ä»¶å¹¶å¯åŠ¨ initGame
  function fetchEventsAndStart() {
    fetch('static/events.json')
      .then(res => {
        if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯ ' + res.status);
        return res.json();
      })
      .then(rawEvents => initGame(rawEvents))
      .catch(err => {
        $('#event-text').text('äº‹ä»¶æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°æˆ–è”ç³»ä½œè€…');
        console.error(err);
      });
  }

  // çœŸæ­£çš„æ¸¸æˆé€»è¾‘å…¥å£
  function initGame(rawEvents) {
    let turnCount = 0;
    let stats = { attr1:50, attr2:50, attr3:50, attr4:50 };
    let lastCause = '';     // ç”¨äºè®°å½•è§¦å‘çš„ç»“å±€ç±»å‹
    let recentEvents = [];  // ä¿å­˜æœ€è¿‘ä¸¤æ¬¡å±•ç¤ºçš„äº‹ä»¶ ID
    let gameOver = false;
    let endingMode = false;
    let chainNext = null;

    // ç»™æ¯ä¸ªäº‹ä»¶è¡¥å…¨é»˜è®¤å­—æ®µ
    const allEvents = rawEvents.map(e => ({
      weight: 1, oneTime: false, chain: false, ending: false,
      acceptUnlock: [], rejectUnlock: [], initial: false,
      // å†è¦†ç›–åŸå§‹å­—æ®µ
      ...e,
      acceptUnlock: Array.isArray(e.acceptUnlock) ? e.acceptUnlock : [],
      rejectUnlock: Array.isArray(e.rejectUnlock) ? e.rejectUnlock : []
    }));

    // äº‹ä»¶æ˜ å°„ã€æ¬¡æ•°ç»Ÿè®¡ã€è§£é”åˆ—è¡¨
    const eventMap = {};
    const countMap = {};
    const unlocked = [];
    allEvents.forEach(e => {
    // å¦‚æœ weight éæ³•ï¼ˆéæ•°å­—æˆ– <=0ï¼‰ï¼Œå¼ºåˆ¶ä¸º 1
      if (typeof e.weight !== 'number' || e.weight <= 0) e.weight = 1;
      eventMap[e.id] = e;
      countMap[e.id] = 0;
      if (e.initial) unlocked.push(e.id);
    });

    // æ¸¸æˆç»“å±€æ ‡é¢˜ï¼ˆåŸå› ï¼‰
    const msgMap = {
      attr1Low: 'å—ä¼¤çš„å°ç’', attr1High: 'è¢«å°ç’æ¨å€’',
      attr2Low: 'è¿™å¤å‡‰äº†',   attr2High: 'å‘é„™çš„å¤å‡‰',
      attr3Low: 'åä¸ºç™½é™è±çš„ç©ºå£³', attr3High: 'è–„é›ªè½»æ‰¬',
      attr4Low: 'é­”æ³•å°‘å¥³å¤±æ ¼', attr4High: 'è£å‡å®çŸ³æƒæ–'
    };

    // æ¸²æŸ“çŠ¶æ€æ¡å’Œå›åˆæ•°
    function renderStats() {
      $('#bar-attr1').css('width', stats.attr1 + '%');
      $('#bar-attr2').css('width', stats.attr2 + '%');
      $('#bar-attr3').css('width', stats.attr3 + '%');
      $('#bar-attr4').css('width', stats.attr4 + '%');
      $('#turn-number').text(turnCount);
    }

    // åŠ æƒéšæœºæŠ½å–ï¼ˆä½¿ç”¨äº†æ­£è§„åŒ–åçš„ weightï¼‰
    function weightedPick(ids) {
      const total = ids.reduce((sum, id) => sum + eventMap[id].weight, 0);
      let r = Math.random() * total;
      for (const id of ids) {
        r -= eventMap[id].weight;
        if (r <= 0) return id;
      }
      return ids[0];
    }

    // æ¸…é™¤ç®­å¤´
    function clearArrows() {
      $('.arrow').css('visibility','hidden');
    }

    // æ˜¾ç¤ºç®­å¤´
    function showArrows(dec) {
      if (currentEvent.ending) return;
      const deltaMap = currentEvent[dec] || {};
      ['attr1','attr2','attr3','attr4'].forEach(key => {
        const d = deltaMap[key] || 0;
        const el = $(`#arrow-${key}`);
        if (d === 0) return el.css('visibility','hidden');
        let sym = d <= -10 ? 'â†“â†“'
                : d < 0    ? 'â†“'
                : d === 0    ? ''
                : d < 10   ? 'â†‘'
                : 'â†‘â†‘';
        el.text(sym).css('visibility','visible');
      });
    }

    let currentEvent = null;

    // æŠ½å–å¹¶æ¸²æŸ“ä¸‹ä¸€äº‹ä»¶
    function nextEvent() {
      if (gameOver || endingMode) return;   // å¤„äºç»“å±€äº‹ä»¶æ—¶ä¸å†æŠ½å–æ–°äº‹ä»¶ï¼ˆå¦‚æœè¦æŠŠç»“å±€äº‹ä»¶åšæˆå¤šä¸ªäº‹ä»¶åˆ™å¯èƒ½è¦æ³¨é‡Šæ‰è¿™æ®µï¼‰
      let pool;
      if (chainNext) {
        pool = chainNext; chainNext = null;       // è¿é”è§£é”åˆ—è¡¨
      } else {
        const avail = unlocked.filter(id => !(eventMap[id].oneTime && countMap[id] > 0));
        pool = avail.filter(id => !eventMap[id].ending);  // ä» unlocked ä¸­å‰”é™¤ä¸€æ¬¡æ€§å·²ç”¨äº‹ä»¶
        if (!pool.length) {
          const minC = Math.min(...unlocked.map(id=>countMap[id]));  // å¾ªç¯ä½¿ç”¨è§£é”åˆ—è¡¨ä¸­å‡ºç°æœ€å°‘çš„
          pool = unlocked.filter(id => countMap[id]===minC && !eventMap[id].ending);  // æ’é™¤ç»“å±€äº‹ä»¶
        }
      }
      // å°è¯•å‰”é™¤æœ€è¿‘å‡ºç°çš„äº‹ä»¶
      const filt = pool.filter(id => !recentEvents.includes(id));
      if (filt.length) pool = filt;

      const id = weightedPick(pool);  // æŒ‰æƒé‡æŠ½å–äº‹ä»¶
      recentEvents.push(id);  // æŠŠæ–°æŠ½å–çš„äº‹ä»¶è®°å½•åˆ° recentEventsï¼ˆåªä¿ç•™æœ€åä¸¤æ¡ï¼‰
      if (recentEvents.length>2) recentEvents.shift();

      currentEvent = eventMap[id];
      $('#event-text').html(currentEvent.text);
      clearArrows();
    }

    // è§¦å‘ç»“å±€äº‹ä»¶
    function startEndingEvent(cause) {
      lastCause = cause;  // ä¿å­˜æ˜¯å“ªç§ç»“å±€
      const eid = 'end-' + cause;
      if (!eventMap[eid]) return showSettlement(cause);
      endingMode = true;
      currentEvent = eventMap[eid];
      $('#event-text').html(currentEvent.text);
      clearArrows();
    }

    // æ£€æŸ¥æ˜¯å¦ç»“æŸ
    function checkGameOver() {
      for (const k in stats) {
        if (stats[k] <= 0) { startEndingEvent(k+'Low'); return true; }
        if (stats[k] >= 100){ startEndingEvent(k+'High'); return true; }
      }
      return false;
    }

    // å±•ç¤ºç»“ç®—ä¸åˆ†äº«
    function showSettlement(cause) {
      gameOver = true;
      const title = msgMap[cause] || 'æœªçŸ¥åŸå› ';
      const shareText = `å­©å­ä»¬ï¼Œæˆ‘æ˜¯ä¿å§†æƒæ–çŸ¢è½¦èŠï¼Œæˆ‘åœ¨é›€æƒä¸­æ‰“å‡ºäº†ç»“å±€ã€${title}ã€‘\nå›åˆæ•°ï¼š${turnCount}\nå°ç’ï¼š${stats.attr1}  å¤å‡‰ï¼š${stats.attr2}  å°ç™½ï¼š${stats.attr3}  è´£ä»»ï¼š${stats.attr4}\nğŸ‘‰ å¿«æ¥æŒ‘æˆ˜ï¼šhttps://notuhao.github.io/quequan-game/`;
      $('body').append(`
        <div id="game-over">
            <h2>æ¸¸æˆç»“æŸï¼š${title}</h2>
            <p>å›åˆæ•°ï¼š${turnCount}</p>
            <p>ã€æœ€ç»ˆç»Ÿè®¡ã€‘</p>
            <p>æ—å°ç’äº²å¯†åº¦ï¼š${stats.attr1}</p>
            <p>å¤å‡‰äº²å¯†åº¦ï¼š${stats.attr2}</p>
            <p>ç™½é™è±äº²å¯†åº¦ï¼š${stats.attr3}</p>
            <p>èº«ä¸ºé­”æ³•å°‘å¥³çš„è´£ä»»ï¼š${stats.attr4}</p>
            <button id="btn-share" class="btn btn-light">åˆ†äº«ç»“æœ</button>
            <small id="share-tip" style="display:none; margin-top:5px;">å†…å®¹å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿</small><br>
            <button id="btn-restart" class="btn btn-light mt-3">é‡æ–°å¼€å§‹</button>
        </div>
      `);
      $('#btn-share').click(() => {
        navigator.clipboard.writeText(shareText).then(()=>$('#share-tip').show());
      });
      $('#btn-restart').click(()=>location.reload());
    }

    // åº”ç”¨å†³ç­–
    function applyDecision(dec) {
      if (gameOver) return;  // å¦‚æœå½“å‰æ˜¯â€œç»“å±€äº‹ä»¶â€ï¼Œç›´æ¥è¿›å…¥ç»“ç®—
      if (endingMode && currentEvent.ending) {
        return showSettlement(lastCause);
      }
      turnCount++;
      const changes = currentEvent[dec] || {};
      for (const k in changes) {
        stats[k] = Math.min(100, Math.max(0, stats[k] + changes[k]));  // ä¿®æ”¹å±æ€§
      }
      renderStats();
      countMap[currentEvent.id]++;

      // è§£é”åç»­è¿é”äº‹ä»¶
      const nextIds = currentEvent[dec + 'Unlock'] || [];
      if (currentEvent.chain && nextIds.length) {
        chainNext = nextIds.slice();
        nextIds.forEach(id=>{ if (!unlocked.includes(id)) unlocked.push(id); });
      }

      if (!checkGameOver()) nextEvent();
    }

    // ç»‘å®šæŒ‰é’®ä¸æ‰‹åŠ¿
    $('#btn-left').click(()=>applyDecision('reject'))
                  .hover(()=>showArrows('reject'), clearArrows);
    $('#btn-right').click(()=>applyDecision('accept'))
                   .hover(()=>showArrows('accept'), clearArrows);
    const mc = new Hammer(document.getElementById('game-card'));
      mc.on('panmove', ev => {
        if (Math.abs(ev.deltaX) < 10) return;
        ev.deltaX > 0 ? showArrows('accept') : showArrows('reject');
      });
      mc.on('swipeleft',  () => $('#game-card').addClass('swipe-left')
                          .delay(300).queue(next => { applyDecision('reject'); $('#game-card').removeClass('swipe-left'); next(); }));
      mc.on('swiperight', () => $('#game-card').addClass('swipe-right')
                          .delay(300).queue(next => { applyDecision('accept'); $('#game-card').removeClass('swipe-right'); next(); }));

    // é¦–æ¬¡æ¸²æŸ“å¹¶æŠ½äº‹ä»¶
    renderStats();
    nextEvent();
  }
  </script>
</body>
</html>
