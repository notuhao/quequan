<!--
  2025 作者：末伏之夜。
  基于 MIT License 开源。
  请务必从可靠来源访问最新版本：
  残兽前进基地（下班魔同人侧） 群号码：805836168
  魔法国度娱乐中心（下班魔游戏群） 群号码：109252951
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>雀权：第二届翠雀杯开赛</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- 内联样式 -->
  <style>
    body { background: #f0f2f5; }
    .stat { width: 100px; }
    .progress-wrapper { position: relative; display: inline-block; }
    .arrow { position: absolute; top: -18px; right: -2px; font-size: 14px; visibility: hidden; }
    #game-card.swipeable:active { cursor: grabbing; }
    #game-card.swipeable.swipe-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
    #game-card.swipeable.swipe-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
    #stats .progress { background: #e9ecef; }
    #turn-count { text-align: center; margin-bottom: 1rem; }
    /* 游戏结束覆盖 */
    #game-over {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); color: #fff;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-size: 1.2rem; z-index: 1000;
    }
    #game-over button { margin-top: 1rem; }
    /* 事件文本保留换行，左对齐 */
    #event-text { white-space: pre-wrap; text-align: left; }
    /* 页脚样式 */
    footer { text-align: center; padding: 8px 0; color: #888; font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container py-3">
    <!-- 回合数：页面最上方居中 -->
    <div id="turn-count" class="text-center">
      <small>回合</small>
      <div><span id="turn-number">0</span></div>
    </div>
    <!-- 顶部信息：状态栏 -->
    <div id="stats" class="d-flex justify-content-around align-items-center mb-4">
      <!-- 小璐 -->
      <div class="stat text-center position-relative">
        <small>小璐</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr1" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr1" class="arrow"></span>
        </div>
      </div>
      <!-- 夏凉 -->
      <div class="stat text-center position-relative">
        <small>夏凉</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr2" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr2" class="arrow"></span>
        </div>
      </div>
      <!-- 小白 -->
      <div class="stat text-center position-relative">
        <small>小白</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr3" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr3" class="arrow"></span>
        </div>
      </div>
      <!-- 责任 -->
      <div class="stat text-center position-relative">
        <small>责任</small>
        <div class="d-inline-block progress-wrapper">
          <div class="progress" style="width: 80px; height: 8px;">
            <div id="bar-attr4" class="progress-bar" role="progressbar"></div>
          </div>
          <span id="arrow-attr4" class="arrow"></span>
        </div>
      </div>
    </div>
    <!-- 卡牌区域 -->
    <div class="d-flex justify-content-center align-items-center" style="height: 70vh;">
      <div id="game-card" class="card shadow-lg rounded-3 swipeable" style="width: 350px; cursor: grab; transition: transform 0.3s;">
        <div class="card-body d-flex align-items-center justify-content-start" style="height: 200px;">
          <p id="event-text" class="card-text">加载中...</p>
        </div>
        <div class="card-footer d-flex justify-content-between">
          <button id="btn-left" class="btn btn-danger"><i class="fas fa-thumbs-down fa-lg"></i></button>
          <button id="btn-right" class="btn btn-success"><i class="fas fa-thumbs-up fa-lg"></i></button>
        </div>
      </div>
    </div>
  </div>
  <!-- 页脚版权声明 -->
  <footer>
    2025 末伏之夜<br>
    请从可靠来源访问最新版本：<br><a href="https://github.com/notuhao/quequan-game" target="_blank">GitHub</a><br><a href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=7SkPyirELH-LN52Tz8PHjl1TLqbHwhdh&authKey=fGUcO5nmulznuZrZUGGJ01CFS4phfoPdo%2B3QoppW5FwcsO%2BsuLHRcpTSdhqYVPrF&noverify=0&group_code=805836168" target="_blank">残兽前进基地（下班魔同人侧）</a><br><a href="http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=rU7wcxZXUtC-U1nafP29Cgv5CfFWlAHl&authKey=%2BrMuEaGIlWVNL7ZKvs1ZoZBWUsUk9X7MEmDMeG1Xy5t86nekeIENl%2BLFytjC4zzg&noverify=0&group_code=109252951" target="_blank">魔法国度娱乐中心（下班魔游戏群）</a>
  </footer>
  <!-- 内嵌事件数据 -->
  <script id="events-data" type="application/json">
[
  {
    "id": "e001",
    "initial": true,
    "weight": 1,
    "text": "面对小璐和小白一起喊“妈妈”的情景，你的选择是？",
    "accept": { "attr1": 25, "attr2": -5, "attr3": 20, "attr4": 20 },
    "reject": { "attr1": -5, "attr2": 10, "attr3": -10, "attr4": 0 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e002",
    "initial": true,
    "weight": 1,
    "text": "小璐在战斗后情绪崩溃，提出想暂时不参加巡逻，希望你替她值班，让她休息一天。",
    "accept": { "attr1": 30, "attr2": -5, "attr3": 5, "attr4": -20 },
    "reject": { "attr1": -20, "attr2": 0, "attr3": 0, "attr4": 20 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e003",
    "initial": true,
    "weight": 1,
    "text": "夏凉发现一个可疑魔力波动请求紧急支援，但这意味着你必须放弃和小白约好的共同巡逻计划。",
    "accept": { "attr1": -5, "attr2": 25, "attr3": -10, "attr4": 15 },
    "reject": { "attr1": 5, "attr2": -20, "attr3": -5, "attr4": -15 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e004",
    "initial": true,
    "weight": 1,
    "text": "小白深夜敲你房门，说她做了噩梦，想靠在你肩上坐一会儿。",
    "accept": { "attr1": 5, "attr2": -5, "attr3": 30, "attr4": -10 },
    "reject": { "attr1": -10, "attr2": 0, "attr3": -20, "attr4": 10 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e005",
    "initial": true,
    "weight": 1,
    "text": "三人吵架后小璐一个人坐在训练场，你要去安慰她吗？但是你之前约好了要为夏凉讲解下一步的训练。",
    "accept": { "attr1": 25, "attr2": -10, "attr3": -5, "attr4": -15 },
    "reject": { "attr1": -15, "attr2": 10, "attr3": 5, "attr4": 20 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e006",
    "initial": true,
    "weight": 1,
    "text": "小璐生日，她希望你花一天时间和她一起过，但当天你负责的巡逻区很有可能出现残兽。",
    "accept": { "attr1": 30, "attr2": -5, "attr3": 0, "attr4": -40 },
    "reject": { "attr1": -10, "attr2": 5, "attr3": 5, "attr4": 25 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e007",
    "initial": true,
    "weight": 1,
    "text": "你需要单独执行一次任务，但小璐担心你安危，请求陪同前往。不过你知道这样会让小璐陷入危险之中。",
    "accept": { "attr1": 20, "attr2": 0, "attr3": 5, "attr4": -25 },
    "reject": { "attr1": -10, "attr2": 5, "attr3": -5, "attr4": 20 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "e008",
    "initial": true,
    "weight": 1,
    "text": "夏凉偷偷告诉你，她觉得自己被忽视了，希望你这周多和她一起训练。",
    "accept": { "attr1": -5, "attr2": 25, "attr3": -5, "attr4": -10 },
    "reject": { "attr1": 10, "attr2": -10, "attr3": 5, "attr4": 15 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },

  {
    "id": "bct1",
    "initial": true,
    "weight": 10,
    "chain": true,
    "oneTime": true,
    "text": "小白经历了数次战斗后性格变得冷漠。深夜，她站在你的房门口沉默地看着你几秒，又转身离开。你是否主动叫住她，与她长谈？",
    "accept": { "attr1": 5, "attr2": -5, "attr3": 25, "attr4": -10 },
    "reject": { "attr1": -5, "attr2": 10, "attr3": -20, "attr4": 15 },
    "acceptUnlock": ["bct3"],
    "rejectUnlock": ["bct2"]
  },
  {
    "id": "bct2",
    "initial": false,
    "weight": 1,
    "chain": true,
    "oneTime": true,
    "text": "你没有叫住小白，只是看着她离开。第二天，她在战斗中毫不顾及自己的伤势，疯狂攻击敌人。夏凉说她像是想被打死……你是否决定私下限制她参战？",
    "accept": { "attr1": -10, "attr2": 10, "attr3": -20, "attr4": 20 },
    "reject": { "attr1": 0, "attr2": -5, "attr3": 5, "attr4": -15 },
    "acceptUnlock": ["bct4"],
    "rejectUnlock": ["bct5"]
  },
  {
    "id": "bct3",
    "initial": false,
    "weight": 1,
    "chain": true,
    "oneTime": true,
    "text": "你叫住了小白，在长谈中她沮丧地说：“……毕竟你最在乎的是小璐和夏凉，不是我。”你该怎么回应？是坦白她误会了你，还是选择转移话题？",
    "accept": { "attr1": 10, "attr2": 0, "attr3": 15, "attr4": -5 },
    "reject": { "attr1": -5, "attr2": 5, "attr3": -10, "attr4": 10 },
    "acceptUnlock": ["bct6"],
    "rejectUnlock": ["bct7"]
  },
  {
    "id": "bct4",
    "initial": false,
    "weight": 1,
    "chain": true,
    "oneTime": true,
    "text": "你决定私下限制小白参战，但她得知后依旧擅自单独行动导致受重伤，重伤后依然不愿被送回基地。你是否强制下令她休养？",
    "accept": { "attr1": -20, "attr2": 0, "attr3": -30, "attr4": 25 },
    "reject": { "attr1": 5, "attr2": 10, "attr3": 5, "attr4": 15 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "bct5",
    "initial": false,
    "weight": 1,
    "chain": true,
    "oneTime": true,
    "text": "你决定不干预小白的行为，只是默默地在战斗中替她挡下致命攻击。这被她看到后，她表面冷漠，却悄悄露出了难过的神情。",
    "accept": { "attr1": 5, "attr2": 0, "attr3": 10, "attr4": -5 },
    "reject": { "attr1": 0, "attr2": 0, "attr3": 0, "attr4": 5 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "bct6",
    "initial": false,
    "weight": 1,
    "chain": true,
    "oneTime": true,
    "text": "你认真告诉她，你并没有最在乎谁，而是每个人你都在乎。她沉默了很久，说她会尝试“相信你一次”。",
    "accept": { "attr1": 15, "attr2": 0, "attr3": 25, "attr4": -5 },
    "reject": { "attr1": 0, "attr2": 0, "attr3": -5, "attr4": 5 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "bct7",
    "initial": false,
    "weight": 1,
    "chain": true,
    "oneTime": true,
    "text": "你含糊其辞，说以后有时间再谈，小白露出失望的神情，点点头离开了。你是否主动制造另一个独处机会？",
    "accept": { "attr1": 0, "attr2": 0, "attr3": -10, "attr4": 0 },
    "reject": { "attr1": 5, "attr2": -5, "attr3": 5, "attr4": 5 },
    "acceptUnlock": [],
    "rejectUnlock": []
  },

  {
    "id": "end-attr1Low",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【受伤的小璐】\n被你忽视的小璐最近一直显得心事重重，最终导致了行动失误，在战斗中负伤。",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr1High",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【被小璐推倒】\n在对小璐过度溺爱的背后，你渐渐失去了独立应对两人关系的能力。最终你被小璐推倒了。",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr2Low",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【这夏凉了】\n夏凉的内心被你的疏忽刺痛，她决定离开队伍，寻求新的开始。",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr2High",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【卑鄙的夏凉】\n夏凉在被你纵容后，野心膨胀，得寸进尺。最终你们的关系彻底崩塌。",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr3Low",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【名为白静萱的空壳】\n小白的信任之弦彻底断裂，她再也无法与你共鸣。你眼前的“白静萱”只剩下空壳。",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr3High",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【薄雪轻扬】\n在你无微不至的关怀下，小白的孝心渐渐变质了……",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr4Low",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【魔法少女失格】\n你的失职导致了你难以接受的不幸……",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  },
  {
    "id": "end-attr4High",
    "initial": false,
    "ending": true,
    "weight": 1,
    "text": "【荣升宝石权杖】\n你活跃表现引起了魔法国度的注意，你被迫成为了尊贵的宝石权杖。但代价是，你再也无法回到曾经的平凡。",
    "accept": {},
    "reject": {},
    "acceptUnlock": [],
    "rejectUnlock": []
  }
]
  </script>
  <!-- 库文件 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
  <!-- 内联脚本 -->
  <script>
  $(function() {
    let turnCount = 0;
    let stats = { attr1:50, attr2:50, attr3:50, attr4:50 };
    let rawEvents = JSON.parse($('#events-data').html());
    let lastCause = '';     // 用于记录触发的结局类型
    let recentEvents = [];   // 保存最近两次展示的事件 ID

    // 1. 给每个事件补全默认字段
    let allEvents = rawEvents.map(e => {
      return {
        // 默认值
        weight: 1,
        oneTime: false,
        chain: false,
        ending: false,
        acceptUnlock: [],
        rejectUnlock: [],
        initial: false,
        // 再覆盖原始字段
        ...e,
        // 最后保障 acceptUnlock/rejectUnlock 至少是数组
        acceptUnlock: Array.isArray(e.acceptUnlock) ? e.acceptUnlock : [],
        rejectUnlock: Array.isArray(e.rejectUnlock) ? e.rejectUnlock : []
      };
    });

    // 2. 事件映射、次数统计、解锁列表
    let eventMap = {}, countMap = {}, unlocked = [], endingMode = false, chainNext = null;
    allEvents.forEach(e => {
      // 如果 weight 非法（非数字或 <=0），强制为 1
      if (typeof e.weight !== 'number' || e.weight <= 0) e.weight = 1;
      eventMap[e.id] = e;
      countMap[e.id] = 0;
      if (e.initial) unlocked.push(e.id);
    });

    let available = unlocked.slice(), currentEvent = null, gameOver = false;

    // 游戏结局标题（原因）
    const msgMap = {
      attr1Low: '受伤的小璐', attr1High: '被小璐推倒',
      attr2Low: '这夏凉了',   attr2High: '卑鄙的夏凉',
      attr3Low: '名为白静萱的空壳', attr3High: '薄雪轻扬',
      attr4Low: '魔法少女失格', attr4High: '荣升宝石权杖'
    };

    function renderStats() {
      $('#bar-attr1').css('width', stats.attr1 + '%');
      $('#bar-attr2').css('width', stats.attr2 + '%');
      $('#bar-attr3').css('width', stats.attr3 + '%');
      $('#bar-attr4').css('width', stats.attr4 + '%');
      $('#turn-number').text(turnCount);
    }

    // 加权随机抽取（使用了正规化后的 weight）
    function weightedPick(ids) {
      let total = ids.reduce((sum, id) => sum + eventMap[id].weight, 0);
      let r = Math.random() * total, acc = 0;
      for (let id of ids) {
        acc += eventMap[id].weight;
        if (r <= acc) return id;
      }
      return ids[0];
    }

    // 进入下一事件
    function nextEvent() {
      if (gameOver) return;
      let pool;
      if (endingMode) return;   // 处于结局事件时不再抽取新事件（如果要把结局事件做成多个事件则可能要注释掉这段）
      if (chainNext) {
        pool = chainNext;       // 连锁解锁列表
        chainNext = null;
      } else {
        // 从 unlocked 中剔除一次性已用事件
        let avail = unlocked.filter(id => !(eventMap[id].oneTime && countMap[id] > 0));
        // 排除结局事件
        pool = avail.filter(id => !eventMap[id].ending);
      }
      if (!pool.length) {
        // 循环使用解锁列表中出现最少的
        let minC = Math.min(...unlocked.map(id => countMap[id]));
        pool = unlocked.filter(id => countMap[id] === minC && !eventMap[id].ending);
      }
      // 尝试剔除最近出现的事件
      let filtered = pool.filter(id => !recentEvents.includes(id));
      if (filtered.length > 0) {
        pool = filtered;
      }
      // 按权重抽取事件
      let id = weightedPick(pool);
      // 把新抽取的事件记录到 recentEvents（只保留最后两条）
      recentEvents.push(id);
      if (recentEvents.length > 2) recentEvents.shift();
      // 渲染
      currentEvent = eventMap[id];
      $('#event-text').html(currentEvent.text);
      clearArrows();
    }

    // 启动结局事件
    function startEndingEvent(cause) {
      lastCause = cause;             // 保存是哪种结局
      let eid = 'end-' + cause;
      if (!eventMap[eid]) {
        showSettlement(cause);
      } else {
        endingMode = true;
        currentEvent = eventMap[eid];
        $('#event-text').html(currentEvent.text);
        clearArrows();
      }
    }

    // 检查游戏结束
    function checkGameOver() {
      for (let k in stats) {
        if (stats[k] <= 0) { startEndingEvent(k + 'Low'); return true; }
        if (stats[k] >= 100) { startEndingEvent(k + 'High'); return true; }
      }
      return false;
    }

    // 正式展示结算并添加分享按钮
    function showSettlement(cause) {
      gameOver = true;
      let title = msgMap[cause] || '未知原因';
      let shareText = `孩子们，我是保姆权杖矢车菊，我在雀权中打出了结局【${title}】\n回合数：${turnCount}\n小璐：${stats.attr1}  夏凉：${stats.attr2}  小白：${stats.attr3}  责任：${stats.attr4}\n👉 快来挑战：https://notuhao.github.io/quequan-game/`;
      $('body').append(`
        <div id="game-over">
          <h2>游戏结束：${title}</h2>
          <p>回合数：${turnCount}</p>
          <p>【最终统计】</p>
          <p>林小璐亲密度：${stats.attr1}</p>
          <p>夏凉亲密度：${stats.attr2}</p>
          <p>白静萱亲密度：${stats.attr3}</p>
          <p>身为魔法少女的责任：${stats.attr4}</p>
          <button id="btn-share" class="btn btn-light">分享本局</button>
          <small id="share-tip" style="display:none; margin-top:5px;">内容已复制到剪切板</small><br>
          <button id="btn-restart" class="btn btn-light mt-3">重新开始</button>
        </div>
      `);
      $('#btn-share').on('click', () => {
        navigator.clipboard.writeText(shareText).then(() => {
          $('#share-tip').show();
        });
      });
      $('#btn-restart').on('click', () => location.reload());
    }

    // 应用用户决策
    function applyDecision(dec) {
      if (gameOver) return;
      // 如果当前是“结局事件”，直接进入结算
      if (endingMode && currentEvent.ending) {
        showSettlement(lastCause);
        return;
      }
      turnCount++;
      let d = currentEvent[dec];
      // 修改属性
      for (let k in d) stats[k] = Math.min(100, Math.max(0, stats[k] + d[k]));
      renderStats();
      // 标记一次性事件已用
      if (currentEvent.oneTime) countMap[currentEvent.id]++;
      else countMap[currentEvent.id]++;
      // 解锁后续连锁事件
      let nextIds = currentEvent[dec + 'Unlock'];
      if (currentEvent.chain && nextIds.length) {
        chainNext = nextIds.slice();
        nextIds.forEach(id => { if (!unlocked.includes(id)) unlocked.push(id); });
      }
      // 检查游戏结束
      if (!checkGameOver()) nextEvent();
    }

    // 箭头提示
    function getArrow(v) {
      if (v <= -10) return '↓↓';
      if (v < 0)    return '↓';
      if (v = 0)    return '';
      if (v < 10)   return '↑';
      return '↑↑';
    }
    function showArrows(dec) {
      let d = currentEvent[dec] || {};
      ['attr1','attr2','attr3','attr4'].forEach(s => {
        let delta = d[s] || 0;
        let el = $(`#arrow-${s}`);
        if (delta !== 0) {
          el.text(getArrow(delta)).css('visibility','visible');
        } else {
          el.css('visibility','hidden');
        }
      });
    }
    function clearArrows() {
      $('.arrow').css('visibility','hidden');
    }

    // 绑定按钮与手势
    $('#btn-left').on('click', () => applyDecision('reject'))
                   .hover(() => showArrows('reject'), clearArrows);
    $('#btn-right').on('click', () => applyDecision('accept'))
                    .hover(() => showArrows('accept'), clearArrows);
    const mc = new Hammer(document.getElementById('game-card'));
    mc.on('swipeleft',  () => $('#game-card').addClass('swipe-left')
                        .delay(300).queue(next => { applyDecision('reject'); $('#game-card').removeClass('swipe-left'); next(); }));
    mc.on('swiperight', () => $('#game-card').addClass('swipe-right')
                        .delay(300).queue(next => { applyDecision('accept'); $('#game-card').removeClass('swipe-right'); next(); }));

    // 启动游戏
    renderStats();
    nextEvent();
  });
  </script>
</body>
</html>
